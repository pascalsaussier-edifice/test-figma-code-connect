{"version":3,"file":"index.umd.js","sources":["../src/MathematicsPlugin.ts","../src/mathematics.ts"],"sourcesContent":["import { getChangedRanges } from '@tiptap/core'\nimport {\n  EditorState, Plugin, PluginKey, Transaction,\n} from '@tiptap/pm/state'\nimport { Decoration, DecorationSet } from '@tiptap/pm/view'\nimport katex from 'katex'\n\nimport { MathematicsOptionsWithEditor } from './types.js'\n\ntype DecoSpec = {\n  isEditable: boolean;\n  isEditing: boolean;\n  katexOptions: MathematicsOptionsWithEditor['katexOptions'];\n  content: string;\n};\n\ntype Deco = Omit<Decoration, 'spec'> & { spec: DecoSpec };\n\ntype PluginState =\n| { decorations: DecorationSet; isEditable: boolean }\n| { decorations: undefined; isEditable: undefined }\n\n/**\n * Get the range of positions that have been affected by a transaction\n */\nfunction getAffectedRange(newState: EditorState, previousPluginState: PluginState, isEditable: boolean, tr: Transaction, state: EditorState) {\n  const docSize = newState.doc.nodeSize - 2\n  let minFrom = 0\n  let maxTo = docSize\n\n  if (previousPluginState.isEditable !== isEditable) {\n    // When the editable state changes, run on all nodes just to be safe\n    minFrom = 0\n    maxTo = docSize\n  } else if (tr.docChanged) {\n    // When the document changes, only run on the nodes that have changed\n    minFrom = docSize\n    maxTo = 0\n\n    getChangedRanges(tr).forEach(range => {\n      // Purposefully over scan the range to ensure we catch all decorations\n      minFrom = Math.min(minFrom, range.newRange.from - 1, range.oldRange.from - 1)\n      maxTo = Math.max(maxTo, range.newRange.to + 1, range.oldRange.to + 1)\n    })\n  } else if (tr.selectionSet) {\n    const { $from, $to } = state.selection\n    const { $from: $newFrom, $to: $newTo } = newState.selection\n\n    // When the selection changes, run on all the nodes between the old and new selection\n    minFrom = Math.min(\n      // Purposefully over scan the range to ensure we catch all decorations\n      $from.depth === 0 ? 0 : $from.before(),\n      $newFrom.depth === 0 ? 0 : $newFrom.before(),\n    )\n    maxTo = Math.max(\n      $to.depth === 0 ? maxTo : $to.after(),\n      $newTo.depth === 0 ? maxTo : $newTo.after(),\n    )\n  }\n\n  return {\n    minFrom: Math.max(minFrom, 0),\n    maxTo: Math.min(maxTo, docSize),\n  }\n}\n\nexport const MathematicsPlugin = (options: MathematicsOptionsWithEditor) => {\n  const {\n    regex, katexOptions = {}, editor, shouldRender,\n  } = options\n\n  return new Plugin<PluginState>({\n    key: new PluginKey('mathematics'),\n\n    state: {\n      init() {\n        return { decorations: undefined, isEditable: undefined }\n      },\n      apply(tr, previousPluginState, state, newState) {\n\n        if (!tr.docChanged && !tr.selectionSet && previousPluginState.decorations) {\n          // Just reuse the existing decorations, since nothing should have changed\n          return previousPluginState\n        }\n\n        const nextDecorationSet = (previousPluginState.decorations || DecorationSet.empty).map(\n          tr.mapping,\n          tr.doc,\n        )\n        const { selection } = newState\n        const isEditable = editor.isEditable\n        const decorationsToAdd = [] as Deco[]\n        const { minFrom, maxTo } = getAffectedRange(newState, previousPluginState, isEditable, tr, state)\n\n        newState.doc.nodesBetween(minFrom, maxTo, (node, pos) => {\n          const enabled = shouldRender(newState, pos, node)\n\n          if (node.isText && node.text && enabled) {\n            let match: RegExpExecArray | null\n\n            // eslint-disable-next-line no-cond-assign\n            while ((match = regex.exec(node.text))) {\n              const from = pos + match.index\n              const to = from + match[0].length\n              const content = match.slice(1).find(Boolean)\n\n              if (content) {\n                const selectionSize = selection.from - selection.to\n                const anchorIsInside = selection.anchor >= from && selection.anchor <= to\n                const rangeIsInside = selection.from >= from && selection.to <= to\n                const isEditing = (selectionSize === 0 && anchorIsInside) || rangeIsInside\n\n                if (\n                  // Are the decorations already present?\n                  nextDecorationSet.find(\n                    from,\n                    to,\n                    (deco: DecoSpec) => isEditing === deco.isEditing\n                      && content === deco.content\n                      && isEditable === deco.isEditable\n                      && katexOptions === deco.katexOptions,\n                  ).length\n                ) {\n                  // Decoration exists in set, no need to add it again\n                  continue\n                }\n                // Use an inline decoration to either hide original (preview is showing) or show it (editing \"mode\")\n                decorationsToAdd.push(\n                  Decoration.inline(\n                    from,\n                    to,\n                    {\n                      class:\n                        isEditing && isEditable\n                          ? 'Tiptap-mathematics-editor'\n                          : 'Tiptap-mathematics-editor Tiptap-mathematics-editor--hidden',\n                      style:\n                        !isEditing || !isEditable\n                          ? 'display: inline-block; height: 0; opacity: 0; overflow: hidden; position: absolute; width: 0;'\n                          : undefined,\n                    },\n                    {\n                      content,\n                      isEditable,\n                      isEditing,\n                      katexOptions,\n                    } satisfies DecoSpec,\n                  ),\n                )\n\n                if (!isEditable || !isEditing) {\n                  // Create decoration widget and add KaTeX preview if selection is not within the math-editor\n                  decorationsToAdd.push(\n                    Decoration.widget(\n                      from,\n                      () => {\n                        const element = document.createElement('span')\n\n                        // TODO: changeable class names\n                        element.classList.add('Tiptap-mathematics-render')\n\n                        if (isEditable) {\n                          element.classList.add('Tiptap-mathematics-render--editable')\n                        }\n\n                        try {\n                          katex.render(content!, element, katexOptions)\n                        } catch {\n                          element.innerHTML = content!\n                        }\n\n                        return element\n                      },\n                      {\n                        content,\n                        isEditable,\n                        isEditing,\n                        katexOptions,\n                      } satisfies DecoSpec,\n                    ),\n                  )\n                }\n              }\n            }\n          }\n        })\n\n        // Remove any decorations that exist at the same position, they will be replaced by the new decorations\n        const decorationsToRemove = decorationsToAdd.flatMap(deco => nextDecorationSet.find(deco.from, deco.to))\n\n        return {\n          decorations: nextDecorationSet\n            // Remove existing decorations that are going to be replaced\n            .remove(decorationsToRemove)\n            // Add any new decorations\n            .add(tr.doc, decorationsToAdd),\n          isEditable,\n        }\n      },\n    },\n\n    props: {\n      decorations(state) {\n        return this.getState(state)?.decorations ?? DecorationSet.empty\n      },\n    },\n  })\n}\n","import { Extension } from '@tiptap/core'\nimport { EditorState } from '@tiptap/pm/state'\n\nimport { MathematicsPlugin } from './MathematicsPlugin.js'\nimport { MathematicsOptions } from './types.js'\n\nexport const defaultShouldRender = (state: EditorState, pos: number) => {\n  const $pos = state.doc.resolve(pos)\n  const isInCodeBlock = $pos.parent.type.name === 'codeBlock'\n\n  return !isInCodeBlock\n}\n\nexport const Mathematics = Extension.create<MathematicsOptions>({\n  name: 'Mathematics',\n\n  addOptions() {\n    return {\n      // eslint-disable-next-line no-useless-escape\n      regex: /\\$([^\\$]*)\\$/gi,\n      katexOptions: undefined,\n      shouldRender: defaultShouldRender,\n    }\n  },\n\n  addProseMirrorPlugins() {\n    return [MathematicsPlugin({ ...this.options, editor: this.editor })]\n  },\n})\n\nexport default Mathematics\n"],"names":["getChangedRanges","Plugin","PluginKey","DecorationSet","Decoration","Extension"],"mappings":"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"}