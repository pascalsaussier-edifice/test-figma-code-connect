{"version":3,"file":"index.cjs","sources":["../src/MathematicsPlugin.ts","../src/mathematics.ts"],"sourcesContent":["import { getChangedRanges } from '@tiptap/core'\nimport {\n  EditorState, Plugin, PluginKey, Transaction,\n} from '@tiptap/pm/state'\nimport { Decoration, DecorationSet } from '@tiptap/pm/view'\nimport katex from 'katex'\n\nimport { MathematicsOptionsWithEditor } from './types.js'\n\ntype DecoSpec = {\n  isEditable: boolean;\n  isEditing: boolean;\n  katexOptions: MathematicsOptionsWithEditor['katexOptions'];\n  content: string;\n};\n\ntype Deco = Omit<Decoration, 'spec'> & { spec: DecoSpec };\n\ntype PluginState =\n| { decorations: DecorationSet; isEditable: boolean }\n| { decorations: undefined; isEditable: undefined }\n\n/**\n * Get the range of positions that have been affected by a transaction\n */\nfunction getAffectedRange(newState: EditorState, previousPluginState: PluginState, isEditable: boolean, tr: Transaction, state: EditorState) {\n  const docSize = newState.doc.nodeSize - 2\n  let minFrom = 0\n  let maxTo = docSize\n\n  if (previousPluginState.isEditable !== isEditable) {\n    // When the editable state changes, run on all nodes just to be safe\n    minFrom = 0\n    maxTo = docSize\n  } else if (tr.docChanged) {\n    // When the document changes, only run on the nodes that have changed\n    minFrom = docSize\n    maxTo = 0\n\n    getChangedRanges(tr).forEach(range => {\n      // Purposefully over scan the range to ensure we catch all decorations\n      minFrom = Math.min(minFrom, range.newRange.from - 1, range.oldRange.from - 1)\n      maxTo = Math.max(maxTo, range.newRange.to + 1, range.oldRange.to + 1)\n    })\n  } else if (tr.selectionSet) {\n    const { $from, $to } = state.selection\n    const { $from: $newFrom, $to: $newTo } = newState.selection\n\n    // When the selection changes, run on all the nodes between the old and new selection\n    minFrom = Math.min(\n      // Purposefully over scan the range to ensure we catch all decorations\n      $from.depth === 0 ? 0 : $from.before(),\n      $newFrom.depth === 0 ? 0 : $newFrom.before(),\n    )\n    maxTo = Math.max(\n      $to.depth === 0 ? maxTo : $to.after(),\n      $newTo.depth === 0 ? maxTo : $newTo.after(),\n    )\n  }\n\n  return {\n    minFrom: Math.max(minFrom, 0),\n    maxTo: Math.min(maxTo, docSize),\n  }\n}\n\nexport const MathematicsPlugin = (options: MathematicsOptionsWithEditor) => {\n  const {\n    regex, katexOptions = {}, editor, shouldRender,\n  } = options\n\n  return new Plugin<PluginState>({\n    key: new PluginKey('mathematics'),\n\n    state: {\n      init() {\n        return { decorations: undefined, isEditable: undefined }\n      },\n      apply(tr, previousPluginState, state, newState) {\n\n        if (!tr.docChanged && !tr.selectionSet && previousPluginState.decorations) {\n          // Just reuse the existing decorations, since nothing should have changed\n          return previousPluginState\n        }\n\n        const nextDecorationSet = (previousPluginState.decorations || DecorationSet.empty).map(\n          tr.mapping,\n          tr.doc,\n        )\n        const { selection } = newState\n        const isEditable = editor.isEditable\n        const decorationsToAdd = [] as Deco[]\n        const { minFrom, maxTo } = getAffectedRange(newState, previousPluginState, isEditable, tr, state)\n\n        newState.doc.nodesBetween(minFrom, maxTo, (node, pos) => {\n          const enabled = shouldRender(newState, pos, node)\n\n          if (node.isText && node.text && enabled) {\n            let match: RegExpExecArray | null\n\n            // eslint-disable-next-line no-cond-assign\n            while ((match = regex.exec(node.text))) {\n              const from = pos + match.index\n              const to = from + match[0].length\n              const content = match.slice(1).find(Boolean)\n\n              if (content) {\n                const selectionSize = selection.from - selection.to\n                const anchorIsInside = selection.anchor >= from && selection.anchor <= to\n                const rangeIsInside = selection.from >= from && selection.to <= to\n                const isEditing = (selectionSize === 0 && anchorIsInside) || rangeIsInside\n\n                if (\n                  // Are the decorations already present?\n                  nextDecorationSet.find(\n                    from,\n                    to,\n                    (deco: DecoSpec) => isEditing === deco.isEditing\n                      && content === deco.content\n                      && isEditable === deco.isEditable\n                      && katexOptions === deco.katexOptions,\n                  ).length\n                ) {\n                  // Decoration exists in set, no need to add it again\n                  continue\n                }\n                // Use an inline decoration to either hide original (preview is showing) or show it (editing \"mode\")\n                decorationsToAdd.push(\n                  Decoration.inline(\n                    from,\n                    to,\n                    {\n                      class:\n                        isEditing && isEditable\n                          ? 'Tiptap-mathematics-editor'\n                          : 'Tiptap-mathematics-editor Tiptap-mathematics-editor--hidden',\n                      style:\n                        !isEditing || !isEditable\n                          ? 'display: inline-block; height: 0; opacity: 0; overflow: hidden; position: absolute; width: 0;'\n                          : undefined,\n                    },\n                    {\n                      content,\n                      isEditable,\n                      isEditing,\n                      katexOptions,\n                    } satisfies DecoSpec,\n                  ),\n                )\n\n                if (!isEditable || !isEditing) {\n                  // Create decoration widget and add KaTeX preview if selection is not within the math-editor\n                  decorationsToAdd.push(\n                    Decoration.widget(\n                      from,\n                      () => {\n                        const element = document.createElement('span')\n\n                        // TODO: changeable class names\n                        element.classList.add('Tiptap-mathematics-render')\n\n                        if (isEditable) {\n                          element.classList.add('Tiptap-mathematics-render--editable')\n                        }\n\n                        try {\n                          katex.render(content!, element, katexOptions)\n                        } catch {\n                          element.innerHTML = content!\n                        }\n\n                        return element\n                      },\n                      {\n                        content,\n                        isEditable,\n                        isEditing,\n                        katexOptions,\n                      } satisfies DecoSpec,\n                    ),\n                  )\n                }\n              }\n            }\n          }\n        })\n\n        // Remove any decorations that exist at the same position, they will be replaced by the new decorations\n        const decorationsToRemove = decorationsToAdd.flatMap(deco => nextDecorationSet.find(deco.from, deco.to))\n\n        return {\n          decorations: nextDecorationSet\n            // Remove existing decorations that are going to be replaced\n            .remove(decorationsToRemove)\n            // Add any new decorations\n            .add(tr.doc, decorationsToAdd),\n          isEditable,\n        }\n      },\n    },\n\n    props: {\n      decorations(state) {\n        return this.getState(state)?.decorations ?? DecorationSet.empty\n      },\n    },\n  })\n}\n","import { Extension } from '@tiptap/core'\nimport { EditorState } from '@tiptap/pm/state'\n\nimport { MathematicsPlugin } from './MathematicsPlugin.js'\nimport { MathematicsOptions } from './types.js'\n\nexport const defaultShouldRender = (state: EditorState, pos: number) => {\n  const $pos = state.doc.resolve(pos)\n  const isInCodeBlock = $pos.parent.type.name === 'codeBlock'\n\n  return !isInCodeBlock\n}\n\nexport const Mathematics = Extension.create<MathematicsOptions>({\n  name: 'Mathematics',\n\n  addOptions() {\n    return {\n      // eslint-disable-next-line no-useless-escape\n      regex: /\\$([^\\$]*)\\$/gi,\n      katexOptions: undefined,\n      shouldRender: defaultShouldRender,\n    }\n  },\n\n  addProseMirrorPlugins() {\n    return [MathematicsPlugin({ ...this.options, editor: this.editor })]\n  },\n})\n\nexport default Mathematics\n"],"names":["getChangedRanges","Plugin","PluginKey","DecorationSet","Decoration","katex","Extension"],"mappings":"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"}