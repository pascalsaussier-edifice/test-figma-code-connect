{"version":3,"file":"attachment.js","sources":["../../src/attachment/attachment.ts"],"sourcesContent":["import { Node } from '@tiptap/core';\n\nexport interface AttachmentOptions {\n  HTMLAttributes: Record<string, string>;\n}\n\ndeclare module '@tiptap/core' {\n  interface Commands<ReturnType> {\n    attachment: {\n      setAttachment: (attachment) => ReturnType;\n      unsetAttachment: (documentId: string) => ReturnType; // Modification de la commande\n    };\n  }\n}\ninterface AttachmentAttrsProps {\n  name: string;\n  href: string;\n  dataDocumentId: string;\n  dataContentType: string;\n}\n\nexport const Attachment = Node.create<AttachmentOptions>({\n  name: 'attachments',\n  content: '',\n  marks: '',\n  group: 'block',\n  selectable: true,\n  atom: true,\n  draggable: true,\n\n  addOptions() {\n    return {\n      HTMLAttributes: {\n        class: 'attachments',\n      },\n    };\n  },\n\n  parseHTML() {\n    return [{ tag: 'div[class=attachments]' }];\n  },\n\n  renderHTML({ HTMLAttributes }) {\n    const links = HTMLAttributes.links;\n\n    const renderedLinks = links.map((el) => {\n      return [\n        'a',\n        {\n          'name': el.name,\n          'href': el.href,\n          'data-document-id': el['data-document-id'],\n          'data-content-type': el['data-content-type'],\n        },\n        el.name,\n      ];\n    });\n\n    return ['div', this.options.HTMLAttributes, ...renderedLinks];\n  },\n\n  addAttributes() {\n    return {\n      links: {\n        default: [],\n        parseHTML: (element) => {\n          const links = element.getElementsByTagName('a');\n          const parsedLinks: AttachmentAttrsProps[] = [];\n\n          for (let i = 0; i < links.length; i++) {\n            const link = links[i];\n            const href = link.getAttribute('href');\n            const name = link.textContent;\n            const regexResult = href.match(/([^/]+$)/);\n            const dataDocumentId =\n              link.getAttribute('data-document-id') ||\n              (regexResult && regexResult[0]);\n            const dataContentType = link.getAttribute('data-content-type');\n\n            parsedLinks.push({\n              href: href,\n              name: name,\n              dataDocumentId,\n              dataContentType,\n            });\n          }\n\n          return parsedLinks;\n        },\n        renderHTML: (attributes) => {\n          return {\n            links: attributes.links.map((link: AttachmentAttrsProps) => ({\n              'href': link.href,\n              'name': link.name,\n              'data-document-id': link.dataDocumentId,\n              'data-content-type': link.dataContentType,\n            })),\n          };\n        },\n      },\n    };\n  },\n\n  addCommands() {\n    return {\n      setAttachment:\n        (\n          attrs = {\n            dataContentType: '',\n            name: '',\n            documentId: '',\n            href: '',\n          },\n        ) =>\n        ({ chain }) => {\n          return chain().insertContent({ type: this.name, attrs }).run();\n        },\n      unsetAttachment:\n        (documentId: string) =>\n        ({ state, dispatch }) => {\n          const { selection } = state;\n          const { from, to } = selection;\n          state.doc.nodesBetween(from, to, (node, pos) => {\n            if (node.type.name === this.name && node.attrs.links.length > 1) {\n              const newLinks = node.attrs.links.filter(\n                (link) => link.documentId !== documentId,\n              );\n              if (newLinks.length !== node.attrs.links.length) {\n                const newAttrs = { ...node.attrs, links: newLinks };\n                dispatch(state.tr.setNodeMarkup(pos, undefined, newAttrs));\n              }\n            } else {\n              dispatch(state.tr.delete(from, to));\n            }\n          });\n          return true;\n        },\n    };\n  },\n});\n"],"names":[],"mappings":";AAqBO,MAAM,aAAa,KAAK,OAA0B;AAAA,EACvD,MAAM;AAAA,EACN,SAAS;AAAA,EACT,OAAO;AAAA,EACP,OAAO;AAAA,EACP,YAAY;AAAA,EACZ,MAAM;AAAA,EACN,WAAW;AAAA,EAEX,aAAa;AACX,WAAO;AAAA,MACL,gBAAgB;AAAA,QACd,OAAO;AAAA,MAAA;AAAA,IACT;AAAA,EAEJ;AAAA,EAEA,YAAY;AACV,WAAO,CAAC,EAAE,KAAK,0BAA0B;AAAA,EAC3C;AAAA,EAEA,WAAW,EAAE,kBAAkB;AAG7B,UAAM,gBAFQ,eAAe,MAED,IAAI,CAAC,OACxB;AAAA,MACL;AAAA,MACA;AAAA,QACE,MAAQ,GAAG;AAAA,QACX,MAAQ,GAAG;AAAA,QACX,oBAAoB,GAAG,kBAAkB;AAAA,QACzC,qBAAqB,GAAG,mBAAmB;AAAA,MAAA;AAAA,MAE7C,GAAG;AAAA,IAAA,CAEN;AAED,WAAO,CAAC,OAAO,KAAK,QAAQ,gBAAgB,GAAG,aAAa;AAAA,EAC9D;AAAA,EAEA,gBAAgB;AACd,WAAO;AAAA,MACL,OAAO;AAAA,QACL,SAAS,CAAA;AAAA,QACT,WAAW,CAAC,YAAY;AACtB,gBAAM,QAAQ,QAAQ,qBAAqB,GAAG,GACxC,cAAsC,CAAA;AAE5C,mBAAS,IAAI,GAAG,IAAI,MAAM,QAAQ,KAAK;AACrC,kBAAM,OAAO,MAAM,CAAC,GACd,OAAO,KAAK,aAAa,MAAM,GAC/B,OAAO,KAAK,aACZ,cAAc,KAAK,MAAM,UAAU,GACnC,iBACJ,KAAK,aAAa,kBAAkB,KACnC,eAAe,YAAY,CAAC,GACzB,kBAAkB,KAAK,aAAa,mBAAmB;AAE7D,wBAAY,KAAK;AAAA,cACf;AAAA,cACA;AAAA,cACA;AAAA,cACA;AAAA,YAAA,CACD;AAAA,UACH;AAEA,iBAAO;AAAA,QACT;AAAA,QACA,YAAY,CAAC,gBACJ;AAAA,UACL,OAAO,WAAW,MAAM,IAAI,CAAC,UAAgC;AAAA,YAC3D,MAAQ,KAAK;AAAA,YACb,MAAQ,KAAK;AAAA,YACb,oBAAoB,KAAK;AAAA,YACzB,qBAAqB,KAAK;AAAA,UAAA,EAC1B;AAAA,QAAA;AAAA,MAEN;AAAA,IACF;AAAA,EAEJ;AAAA,EAEA,cAAc;AACZ,WAAO;AAAA,MACL,eACE,CACE,QAAQ;AAAA,QACN,iBAAiB;AAAA,QACjB,MAAM;AAAA,QACN,YAAY;AAAA,QACZ,MAAM;AAAA,MAAA,MAGV,CAAC,EAAE,YACM,MAAA,EAAQ,cAAc,EAAE,MAAM,KAAK,MAAM,OAAO,EAAE,IAAA;AAAA,MAE7D,iBACE,CAAC,eACD,CAAC,EAAE,OAAO,eAAe;AACvB,cAAM,EAAE,cAAc,OAChB,EAAE,MAAM,GAAA,IAAO;AACrB,qBAAM,IAAI,aAAa,MAAM,IAAI,CAAC,MAAM,QAAQ;AAC9C,cAAI,KAAK,KAAK,SAAS,KAAK,QAAQ,KAAK,MAAM,MAAM,SAAS,GAAG;AAC/D,kBAAM,WAAW,KAAK,MAAM,MAAM;AAAA,cAChC,CAAC,SAAS,KAAK,eAAe;AAAA,YAAA;AAEhC,gBAAI,SAAS,WAAW,KAAK,MAAM,MAAM,QAAQ;AAC/C,oBAAM,WAAW,EAAE,GAAG,KAAK,OAAO,OAAO,SAAA;AACzC,uBAAS,MAAM,GAAG,cAAc,KAAK,QAAW,QAAQ,CAAC;AAAA,YAC3D;AAAA,UACF;AACE,qBAAS,MAAM,GAAG,OAAO,MAAM,EAAE,CAAC;AAAA,QAEtC,CAAC,GACM;AAAA,MACT;AAAA,IAAA;AAAA,EAEN;AACF,CAAC;"}